name: Auto-Mod√©ration (CRON)

# Ex√©cuter toutes les 5 minutes
on:
  schedule:
    - cron: '*/5 * * * *'  # Toutes les 5 minutes
  workflow_dispatch:  # Permet de d√©clencher manuellement

jobs:
  auto-moderate:
    runs-on: ubuntu-latest
    steps:
      - name: V√©rifier les secrets
        run: |
          missing=""
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "‚ùå SUPABASE_URL non configur√©"
            missing="true"
          else
            echo "‚úÖ SUPABASE_URL configur√©"
          fi
          if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "‚ùå SUPABASE_ANON_KEY non configur√©"
            missing="true"
          else
            echo "‚úÖ SUPABASE_ANON_KEY configur√©"
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "‚ö†Ô∏è CRON_SECRET non configur√© (optionnel si pas d√©fini c√¥t√© Supabase)"
          else
            echo "‚úÖ CRON_SECRET configur√©"
          fi
          if [ -n "$missing" ]; then
            echo ""
            echo "üîß Pour configurer les secrets:"
            echo "   GitHub > Settings > Secrets and variables > Actions > New repository secret"
            echo "   - SUPABASE_URL = https://vnhwllsawfaueivykhly.supabase.co"
            echo "   - SUPABASE_ANON_KEY = votre cl√© anon Supabase"
            echo "   - CRON_SECRET = un mot de passe al√©atoire (m√™me valeur dans Supabase Edge Function Secrets)"
            exit 1
          fi

      - name: Appeler Edge Function Auto-Mod√©ration
        run: |
          echo "üì° Appel: ${{ secrets.SUPABASE_URL }}/functions/v1/auto-moderation"
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
            -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/auto-moderation" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "x-api-key: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 30)
          
          echo "üìã HTTP Status: $HTTP_CODE"
          echo "üìã R√©ponse:"
          cat response.json 2>/dev/null || echo "(pas de r√©ponse)"
          echo ""
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Auto-mod√©ration ex√©cut√©e avec succ√®s"
          else
            echo "‚ùå √âchec (HTTP $HTTP_CODE)"
            if [ "$HTTP_CODE" = "401" ]; then
              echo "üîë V√©rifiez que CRON_SECRET correspond √† celui d√©fini dans Supabase Edge Function Secrets"
            elif [ "$HTTP_CODE" = "404" ]; then
              echo "üîç Edge Function 'auto-moderation' non trouv√©e. D√©ployez-la avec: supabase functions deploy auto-moderation"
            elif [ "$HTTP_CODE" = "500" ]; then
              echo "üí• Erreur serveur. V√©rifiez les logs de l'Edge Function dans le dashboard Supabase"
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "üåê Impossible de joindre le serveur. V√©rifiez SUPABASE_URL"
            fi
            exit 1
          fi
