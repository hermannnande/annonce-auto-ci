name: Auto-Mod√©ration (CRON)

# ================================================================
# Appelle directement la fonction SQL auto_approve_pending_listings
# via l'API REST Supabase (PostgREST).
# Pas besoin d'Edge Function - appel direct √† la base de donn√©es.
#
# SECRETS REQUIS (GitHub > Settings > Secrets > Actions):
#   - SUPABASE_URL             = https://vnhwllsawfaueivykhly.supabase.co
#   - SUPABASE_SERVICE_ROLE_KEY = (cl√© service_role depuis Supabase Dashboard > Settings > API)
# ================================================================

on:
  schedule:
    - cron: '*/5 * * * *'  # Toutes les 5 minutes
  workflow_dispatch:  # Permet de d√©clencher manuellement

jobs:
  auto-moderate:
    runs-on: ubuntu-latest
    steps:
      - name: V√©rifier les secrets
        run: |
          missing=""
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "‚ùå SUPABASE_URL non configur√©"
            missing="true"
          else
            echo "‚úÖ SUPABASE_URL configur√©"
          fi
          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "‚ùå SUPABASE_SERVICE_ROLE_KEY non configur√©"
            missing="true"
          else
            echo "‚úÖ SUPABASE_SERVICE_ROLE_KEY configur√©"
          fi
          if [ -n "$missing" ]; then
            echo ""
            echo "üîß Pour configurer les secrets:"
            echo "   GitHub > Settings > Secrets and variables > Actions > New repository secret"
            echo "   - SUPABASE_URL = https://vnhwllsawfaueivykhly.supabase.co"
            echo "   - SUPABASE_SERVICE_ROLE_KEY = votre cl√© service_role (Supabase Dashboard > Settings > API)"
            exit 1
          fi

      - name: Auto-mod√©ration - Appel RPC direct
        run: |
          echo "üì° Appel RPC: auto_approve_pending_listings"
          echo "üïê $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
            -X POST \
            "${{ secrets.SUPABASE_URL }}/rest/v1/rpc/auto_approve_pending_listings" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            --max-time 30)
          
          echo "üìã HTTP Status: $HTTP_CODE"
          echo "üìã R√©ponse:"
          cat response.json 2>/dev/null || echo "(pas de r√©ponse)"
          echo ""
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Auto-mod√©ration ex√©cut√©e avec succ√®s"
          else
            echo "‚ùå √âchec (HTTP $HTTP_CODE)"
            if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
              echo "üîë V√©rifiez SUPABASE_SERVICE_ROLE_KEY (doit √™tre la cl√© service_role, pas anon)"
            elif [ "$HTTP_CODE" = "404" ]; then
              echo "üîç Fonction auto_approve_pending_listings introuvable."
              echo "   Ex√©cutez la migration 012_auto_moderation_hardening.sql dans Supabase SQL Editor"
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "üåê Impossible de joindre le serveur. V√©rifiez SUPABASE_URL"
            fi
            exit 1
          fi
